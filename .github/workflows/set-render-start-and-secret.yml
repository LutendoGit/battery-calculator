name: Set Render Start Command & SECRET_KEY

on:
  workflow_dispatch:

jobs:
  update_render:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate SECRET_KEY
        id: gen
        run: |
          python - <<'PY' > secret.txt
import secrets
print(secrets.token_urlsafe(32))
PY
          SECRET_KEY=$(cat secret.txt)
          echo "SECRET_KEY=$SECRET_KEY" >> $GITHUB_ENV

      - name: Find Render service id
        id: find
        run: |
          services=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" "https://api.render.com/v1/services?limit=200")
          echo "$services" > services.json
          SERVICE_ID=$(echo "$services" | jq -r '.[] | select(.repo=="https://github.com/LutendoGit/battery-calculator.git") | .id')
          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" = "null" ]; then
            SERVICE_ID=$(echo "$services" | jq -r '.[] | select(.name=="battery-calculator") | .id')
          fi
          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" = "null" ]; then
            echo "Service not found" >&2
            exit 1
          fi
          echo "SERVICE_ID=$SERVICE_ID" >> $GITHUB_ENV

      - name: Update Render service startCommand and SECRET_KEY
        run: |
          echo "Updating Render service $SERVICE_ID"
          payload=$(jq -n --arg sc 'gunicorn app:app --workers 2 --threads 4 --bind 0.0.0.0:$PORT --timeout 120' --arg sk "$SECRET_KEY" '{startCommand:$sc, envVars:[{key:"SECRET_KEY", value:$sk, secure:true}]}')
          echo "Payload: $payload"
          resp=$(curl -s -X PATCH "https://api.render.com/v1/services/${SERVICE_ID}" -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" -H "Content-Type: application/json" -d "$payload")
          echo "$resp" | jq .

      - name: Get Service URL
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" "https://api.render.com/v1/services/${SERVICE_ID}" | jq '.url'
